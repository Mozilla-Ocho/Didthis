# Discord bot for Didthis

## Notes

- Bot invite links
  - [`Didthis`](https://discord.com/api/oauth2/authorize?client_id=1195451614593552505&permissions=927712987136&scope=bot+applications.commands)
  - [`Didthis-staging`](https://discord.com/api/oauth2/authorize?client_id=1195452683050557521&permissions=927712987136&scope=bot+applications.commands)
  - [`didthis-dev-lmorchard`](https://discord.com/api/oauth2/authorize?client_id=1186445176378507294&permissions=927712987136&scope=bot+applications.commands)

## Development

### Usage

- `yarn dev` - starts the bot with file watchers to restart on changes
- `yarn cli:dev deploy-slash-commands` - to deploy latest slash command descriptions to Discord
- `yarn build` - compile TypeScript source for compiled production JS build
- `yarn start` - start the bot with compiled production JS build
- `yarn cli` - run the bot CLI from compiled production JS build

### Local Configuration

To run the bot for local development, the first steps include:

1. [Create a new Discord application](https://discordjs.guide/preparations/setting-up-a-bot-application.html)
1. [Invite the bot into a Discord server where you have permission](https://discordjs.guide/preparations/adding-your-bot-to-servers.html) - you might want to create a personal server for this
1. [Enable developer mode in Discord](https://support.discord.com/hc/en-us/articles/206346498-Where-can-I-find-my-User-Server-Message-ID-) to capture the IDs of the Discord server and channel where you want the bot to operate.

With all that prepared, now you can chase down the IDs and secrets necessary for configuration:

1. Edit these files in your `h3y` project directory:
    - `appserver/.env.development.local`
    - `integrations/discord/.env`

1. Add this to `appserver/.env.development.local`
    ```
    NEXT_PUBLIC_DISCORD_CLIENT_ID=
    DISCORD_CLIENT_SECRET=
    ```

1. Add this to `integrations/discord/.env`
    ```
    DISCORD_CLIENT_ID=
    DISCORD_CLIENT_SECRET=
    DISCORD_BOT_TOKEN=
    DISCORD_SERVER_ID=
    DISCORD_CHANNEL_ID=
    ```

1. In the Discord application's OAuth2 settings:
    1. Copy the Client ID
    1. Paste that into `appserver/.env.development.local` as the value for `NEXT_PUBLIC_DISCORD_CLIENT_ID`
    1. Paste that into `integrations/discord/.env` as the value for `DISCORD_CLIENT_ID`
    1. Click "Reset Secret" - this should give you a new secret to copy
    1. Paste that into `appserver/.env.development.local` as the value for `DISCORD_CLIENT_SECRET`
    1. Paste that into `integrations/discord/.env` as the value for `DISCORD_CLIENT_SECRET`

1. In the Discord application's Bot settings:
    1. Click "Reset Token" - this should give you a new token to copy
    1. Paste that into `integrations/discord/.env` as the value for `DISCORD_BOT_TOKEN`

1. In Discord:
    1. Right click the name of your server, pick "Copy Server Id"
    1. Paste that into `integrations/discord/.env` as the value for `DISCORD_SERVER_ID`
    1. Right click the name of your desired channel, pick "Copy Channel Id"
    1. Paste that into `integrations/discord/.env` as the value for `DISCORD_CHANNEL_ID`

From there, you should be able to restart your Docker compose stack and see the bot come online in your Discord server.

### Points of interest:

  - `lib/config.ts`
    - lists all configuration settings and associated env vars

  - `lib/bot/events/ready.ts`
    - event fired when the bot has successfully logged into discord
    - good place for starting long-running activities

  - `lib/bot/publicUpdatesWatcher.ts`
    - a long-running activity that periodically polls public updates on didthis
    - posts messages when it sees new public updates for discord users

  - `lib/bot/events/interactionCreate.ts`
    - where slash commands are processed

  - `lib/bot/slashCommands/`
    - where slash commands are defined
    - run `yarn cli deploy-slash-commands` to update Discord when adding/removing commands
    - need to figure out how to run this in non-prod / prod as part of deployment

  - `lib/didthis-client/index.ts`
    - main client for didthis api, good spot to define new queries
    - uses auto-generated code and types under `gql/`

  - `lib/didthis-client/gql/`
    - do not edit, code generated by [graphql-codegen](https://the-guild.dev/graphql/codegen)
    - should run automatically with `yarn dev`
    - update manually via `yarn generate`
    - requires appserver to be running, since it fetches the latest graphql schema